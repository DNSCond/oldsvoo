!function(t,n,r,i,s){function d(e){var t=r.Deferred(),n=function(){t.resolve.apply(t,arguments).then(e)};return n.isReady=t.promise(),n}function v(){var e=r.Deferred(),t=Array.prototype.slice.call(arguments,0);return r(function(){e.resolve.apply(e,t)}),e.promise()}function S(e){var n={_svgNameSeparator:"::::",_buildColorSvgMap:function(e,t){if(e&&t){var r=n.components[t][e]||c,s=n.svgRulesTree.getUIAdjustableTailors()[t]||[],o=s[n.colorTypes[e]];if(o){var u={};u[o]=i.reduce(n.svgRulesTree.local[o]||[],function(e,n){return n.tailorName===t&&(e.color=e.color||r,e.prop=e.prop||(n.prop==="fill"?"fillColor":"strokeColor"),e.svgRefNames=e.svgRefNames||[],e.svgRefNames.push(n.svgRefName)),e},{});var a=n.svgRulesTree.depsOn[o]||[];return a.length&&(u["_"+o]=i.reduce(a,function(e,t){var n={color:u[o].color,prop:t.prop==="fill"?"fillColor":"strokeColor",svgRefName:t.svgRefName};return t.modifier&&(t.modifier==="darker"?n.color=x.colorLuminance(n.color,-1*h):t.modifier==="lighter"&&(n.color=x.colorLuminance(n.color,h))),e.push(n),e},[])),u}}return null},_applyColorSvgMap:function(e){return e=i.isArray(e)?e:[e],i.chain(e).compact().each(function(e){i.each(e,function(e,t){var r=t.indexOf("_")===0;r?e.forEach(function(e){n.svgMap[e.svgRefName]&&(n.svgMap[e.svgRefName][e.prop]=e.color)}):e.svgRefNames.forEach(function(t){n.svgMap[t]&&(n.svgMap[t][e.prop]=e.color)})})}),n},colorTypes:{color:0,altColor:1},canvas:null,project:null,tailors:null,activeTailor:null,components:null,svgMap:null,changeColor:function(e,t,r){if(n.canvas&&n.project){var s=i.keys(n.colorTypes)[t||0];n.components[r][s]=e;var o=n._buildColorSvgMap(s,r);o&&n._applyColorSvgMap(o).update()}return n},updateColors:function(){if(n.canvas&&n.project){var e=i.keys(n.colorTypes),t=[];i.each(n.components,function(r,s){i.each(e,function(e){r[e]&&t.push(n._buildColorSvgMap(e,s))})}),t.length?n._applyColorSvgMap(t):n.changeColor(c,n.colorTypes.color,l)}return n},clearTailorColors:function(e,t){var r=t||n.components;return r&&e&&r[e]&&(r[e]=i.omit(r[e],i.keys(n.colorTypes))),n},clearAllTailorsColors:function(e){var t=e||n.components;return t&&i.keys(t).forEach(function(e){n.clearTailorColors(e,t)}),n},clear:function(){return n.canvas&&n.project&&(n.project.layers||[]).length&&(n.project.clear(),n.update()),n},update:function(){return n.canvas&&n.project&&n.project.view.draw(),n},draw:function(e,t){return n.canvas&&n.project&&(e&&(n.components=e),t&&(n.components[l].color=t),n.tailors&&n.components&&(n.clear(),n.svgRulesTree.clear(),n.svgMap=i.chain(n.components).map(function(e,t){if(e.dressingName){var r=n.tailors[t];return{tailorName:t,svgSrc:(i.where(r.dressings,{name:e.dressingName})[0]||{}).svg,isFlipX:r.flip_x,zIndex:r["z-index"]}}}).filter(function(e){return e&&e.svgSrc}).sortBy(function(e){return e&&e.zIndex}).reduce(function(e,t){var r=n.project.importSVG(t.svgSrc),s=T.parse(r);if(t.isFlipX){var o=r.handleBounds,u=a-o.width-o.x;r.translate((o.x-u)*-1,0).scale(-1,1)}return s.forEach(function(r){var s=t.tailorName+n._svgNameSeparator+r.name;n.svgRulesTree.addLocal(i.filter(r.rules,function(e){return!e.depOnName}),s,t.tailorName),n.svgRulesTree.addDepsOn(i.filter(r.rules,function(e){return e.depOnName}),s,t.tailorName),e[s]=r.svgRef}),e},{}).value(),n.updateColors(),n.update())),n},init:function(e,o){if(!n.canvas||!n.project)n.tailors=o||{},n.components=e||{},i.keys(n.components).length||(n.components=i.reduce(n.tailors,function(e,t,n){return e[n]={},!t.allow_clear&&t.dressings.length&&(e[n].dressingName=t.dressings[0].name),e},{})),n.canvas=t.document.createElement("canvas"),r(p.canvasContainer).append(n.canvas),n.project=new s.Project(n.canvas),n.project.view.viewSize=new s.Size(a,a),n.draw();return n},updateUI:function(e){(n.tailors[n.activeTailor].dressings||[]).length<=1?e.find(p.nextButton).attr("disabled","disabled").end().find(p.prevButton).attr("disabled","disabled"):e.find(p.nextButton).removeAttr("disabled").end().find(p.prevButton).removeAttr("disabled");var t=n.components[n.activeTailor];e.find(p.colorLabels).removeClass("is-hidden").end().find(p.color).val(t.color||c).end().find(p.altColor).val(t.altColor||c);var r=n.svgRulesTree.getUIAdjustableTailors()[n.activeTailor]||[];return r.length===1?e.find(p.colorLabels+":eq(1)").addClass("is-hidden"):r.length||e.find(p.colorLabels).addClass("is-hidden"),n},wireup:function(){if(!e.isViewEditable||!n.canvas||!n.project)return n;var s=r(p.container);if(n.tailors){var o=i.template('<li id="<%-name%>" class="button <%-classNameMod%>"><div class="icon"></div></li>'),u=i.chain(n.tailors).values().filter(function(e){return e.dressings.length>1}).sortBy(function(e,t){return e["ui-order"]-t["ui-order"]}).map(function(e){return o(i.extend({classNameMod:""},e))}).value();n.activeTailor=l,u.unshift(o({name:l,classNameMod:"selected"})),s.find(p.tailorButtonsContainer).html(u.join(""))}return s.off(".snoovatar").on("click.snoovatar",p.tailorButtons,function(e){s.find(p.tailorButtons).removeClass("selected");var t=r(e.currentTarget);return t.addClass("selected"),n.activeTailor=t.attr("id"),t=null,n.updateUI(s),!0}).on("click.snoovatar",p.nextButton+":not([disabled])",function(e){if(n.activeTailor){var t=r(e.currentTarget).attr("disabled","disabled"),o=n.tailors[n.activeTailor].dressings,u=i.extend({},n.components);u[n.activeTailor].dressingName=x.getNextDressingsName(o,n.components[n.activeTailor].dressingName),n.clearTailorColors(n.activeTailor,u).draw(u).updateUI(s),t.removeAttr("disabled"),t=null}return!0}).on("click.snoovatar",p.prevButton+":not([disabled])",function(e){if(n.activeTailor){var t=r(e.currentTarget).attr("disabled","disabled"),o=n.tailors[n.activeTailor].dressings,u=i.extend({},n.components);u[n.activeTailor].dressingName=x.getPrevDressingsName(o,n.components[n.activeTailor].dressingName),n.clearTailorColors(n.activeTailor,u).draw(u).updateUI(s),t.removeAttr("disabled"),t=null}return!0}).on("click.snoovatar",p.randomButton+":not([disabled])",function(e){var t=r(e.currentTarget).attr("disabled","disabled");return n.clearAllTailorsColors().draw(x.randomizeComponents(n.tailors),x.getRandomColor()).updateUI(s),t.removeAttr("disabled"),t=null,!0}).on("click.snoovatar",p.clearButton+":not([disabled])",function(e){var t=r(e.currentTarget).attr("disabled","disabled"),o=i.chain(n.tailors).values().where({allow_clear:!1}).reduce(function(e,t){return e[t.name]=t.dressings[0].name,e},{}).value(),u=i.reduce(n.components,function(e,t,n){return e[n]=o[n]?{dressingName:o[n]}:{},e},{});return n.clearAllTailorsColors().draw(u,c).updateUI(s),t.removeAttr("disabled"),t=null,!0}).on("click.snoovatar",p.saveButton+":not([disabled])",function(e){var i=r(e.currentTarget).attr("disabled","disabled");return r.request("gold/snoovatar",{api_type:"json","public":s.find(p.publicCheckbox).is(":checked"),snoo_color:n.components[l].color||c,components:t.JSON.stringify(n.components)},function(e){i.removeAttr("disabled"),i=null;var t=null;!e||!e.json?t="unable to save snoovatar":(e.json.errors||[]).length&&(t=e.json.errors.join("\n ")),s.find(p.messageBox).stop().removeClass("error").addClass(t?"error":"").text(t||"snoovatar updated!").slideDown().delay(2500).slideUp()}),!0}).on("click.snoovatar",p.downloadButton+":not([disabled])",function(e){var t=r(e.currentTarget).attr("disabled","disabled");return t[0].href=n.canvas.toDataURL("image/png"),t.removeAttr("disabled"),t=null,!0}).on("change.snoovatar",p.color,function(e){return n.changeColor(e.currentTarget.value,n.colorTypes.color,n.activeTailor),!0}).on("change.snoovatar",p.altColor,function(e){return n.changeColor(e.currentTarget.value,n.colorTypes.altColor,n.activeTailor),!0}),n.updateUI(s)},svgRulesTree:{local:{},depsOn:{},clear:function(){n.svgRulesTree.local={},n.svgRulesTree.depsOn={}},addLocal:function(e,t,r){n.svgRulesTree.local=i.reduce(e,function(e,n){var i=n.prop+"::"+n.name;return e[i]=e[i]||[],e[i].push({tailorName:r,svgRefName:t,prop:n.prop}),e},n.svgRulesTree.local)},addDepsOn:function(e,t,r){n.svgRulesTree.depsOn=i.reduce(e,function(e,n){var i=n.depOnProp+"::"+n.depOnName;return e[i]=e[i]||[],e[i].push({tailorName:r,svgRefName:t,prop:n.prop,modifier:n.depOnModifier}),e},n.svgRulesTree.depsOn)},getUIAdjustableTailors:function(){return i.reduce(n.svgRulesTree.local,function(e,t,n){return(t||[]).forEach(function(t){e[t.tailorName]=e[t.tailorName]||[],e[t.tailorName].indexOf(n)<0&&e[t.tailorName].push(n)}),e},{})}}},o=x.convertLegacyComponents(e.components,e.snooColor);return n.init(o,e.tailors).wireup()}n.snoovatar={};var o=n.snoovatar,u="/static/snoovatar/images/",a=400,f=2,l="snoo-body",c="#ffffff",h=.3,p={container:".js-snoovatar-page",tailorButtonsContainer:".selectors ul",tailorButtons:".selectors ul li",nextButton:"#nextButton",prevButton:"#prevButton",randomButton:"#random",saveButton:"#save",downloadButton:"#download",clearButton:"#clear",canvasContainer:"#snoovatar",sampleContainer:"#samples",sampleButton:"#generate-samples",publicCheckbox:"#public",messageBox:"#message",color:"#color",altColor:"#alt_color",colorLabels:".js-snoo-color-label"};r.preloadSVGs=function(e){return r.when.apply(t,r.map(e,function(e){var s=i.isObject(e),o=r.Deferred();return n.ajax({url:e.url,type:"GET"}).done(function(n,r,i){var n=i.responseText;if(s)try{n=t.JSON.parse(n)}catch(u){}o.resolve({tailor:e.tailor,data:n})}).fail(function(t,n,r){o.resolve({tailor:e.tailor,data:null})}),o.promise()}))},o.initTailors=d(function(e){return e.sort(function(e,t){return e=e["z-index"],t=t["z-index"],e-t}),e}),o.initSnoovatar=d(function(e){return e});var m=document.createElement("canvas");if(!m.getContext||!m.getContext("2d"))return r(function(){r(p.canvasContainer).text(n._("your browser doesn't support snoovatars :("))});var g=document.createElement("canvas").getContext("2d");g.globalCompositeOperation="difference";var y=g.globalCompositeOperation==="difference",b=r.when(v).then(function(){return{isEditable:r(p.canvasContainer).hasClass("editable")}}),w=r.when(o.initTailors.isReady).then(function(e){var t=i.chain(e).pluck("asset_path").map(function(e){return{tailor:e,url:u+e+"/svg_bundle.json"}}).value();return r.preloadSVGs(t)}),E=r.when(w,o.initTailors.isReady,o.initSnoovatar.isReady).then(function(t,n,r){var s=i.reduce(t,function(e,t){return e[t.tailor]=t.data,e},{}),o=i.reduce(n,function(e,t){return t.dressings=i.reduce(t.dressings||[],function(e,n){return n.name&&(n.svg=s[t.asset_path][n.name]),e.push(n),e},[]),e[t.name]=t,e},{});return{tailors:o,components:(r||{}).components||{},snoo_color:(r||{}).snoo_color}});r.when(E,b).then(function(t,r){return n.snooBuilder=S({components:t.components,tailors:t.tailors,snooColor:t.snoo_color,isViewEditable:r.isEditable}),n.snooBuilder});var x={colorLuminance:function(e,n){e=t.String(e).replace(/[^0-9a-f]/gi,""),e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),n=n||0;var r="#",i,s;for(s=0;s<3;s++)i=t.parseInt(e.substr(s*2,2),16),i=t.Math.round(t.Math.min(t.Math.max(0,i+i*n),255)).toString(16),r+=("00"+i).substr(i.length);return r},getRandomColor:function(){return"#"+("000000"+t.Math.floor(t.Math.random()*16777215).toString(16)).slice(-6)},getRandomInt:function(e,n){return t.Math.floor(t.Math.random()*(n-e+1))+e},randomizeComponents:function(e){return i.reduce(e,function(e,t){var n=i.pluck(t.dressings,"name");return n&&n.length&&(e[t.name]={dressingName:function(e){return e.length===1?e[0]:e[x.getRandomInt(0,e.length-1)]}(n)}),e},{})},getNextDressingsName:function(e,t){var n=i.pluck(e,"name")||[],r=n.indexOf(t)+1;return r>=n.length&&(r=0),n[r]},getPrevDressingsName:function(e,t){var n=i.pluck(e,"name")||[],r=n.indexOf(t)-1;return r<0&&(r=n.length-1),n[r]},convertLegacyComponents:function(e,t){var n=["body-fill","head-fill"],r={"body-stroke":"snoo-body","head-stroke":"snoo-head"},s={body_stroke:"body",head_stroke:"head"};return i.reduce(e||{},function(e,i,o){return n.indexOf(o)<0&&(i=i||{},r[o]&&(o=r[o]),typeof i=="string"?(e[o]={dressingName:s[i]?s[i]:i},o===l&&(e[o].color=t)):e[o]=i),e},{})}},T={parse:function(e){var t=[];if(e){if(e.name){var n=N.parse(e.name)||[];n.length&&t.push({name:e.name,svgRef:e,rules:n})}(e.children||[]).forEach(function(e){t=t.concat(T.parse(e))})}return t}},N={_separators:{group:"_x26__x26_",clause:"::",modifier:":",prop:"-"},_splitGroups:function(e){return e.split(N._separators.group)||[]},_splitClauses:function(e){return e.split(N._separators.clause)||[]},_splitModifiers:function(e){return e.split(N._separators.modifier)||[]},_splitProps:function(e){return e.split(N._separators.prop)||[]},_parseProps:function(e){var t=N._splitProps(e),n=t.length;if(n>1){var r=t.pop();return{depOnName:t.join(N._separators.prop),depOnProp:r==="f"?"fill":"stroke"}}return n===1?{depOnName:t[0]}:null},_parseModifiers:function(e){var t=N._splitModifiers(e);return t.length===2?i.extend({depOnModifier:t[1]},N._parseProps(t[0])):t.length===1?N._parseProps(t[0]):null},_parseName:function(e){var t=N._splitModifiers(e);return t.length===2?{name:t[0],group:t[1]}:t.length===1?{name:t[0]}:null},_parseRule:function(e){var t=N._splitClauses(e);return t.length===3?i.extend({prop:t[1],name:t[2]},N._parseModifiers(t[0])):t.length===2?i.extend({prop:t[0]},N._parseName(t[1])):null},parse:function(e){var t=[];if(e){var n=N._splitGroups(e);t=i.reduce(n,function(e,t){var n=N._parseRule(t);return n&&e.push(n),e},t)}return t}}}(window,window.r,window.jQuery,window._,window.paper),r.snoovatar.initTailors([{asset_path:"bottoms",allow_clear:!0,name:"bottoms",dressings:[{name:"bottoms"},{name:"denim"},{name:"skirt"},{name:"solo"},{name:"striped-pants"},{name:"two-tone"},{name:"wavy-skirt"},{name:"y-fronts"}],use_dynamic_color:!1,"z-index":200,flippable:!1,flip_x:!1,"ui-order":6},{asset_path:"glasses",allow_clear:!0,name:"glasses",dressings:[{name:"accent-glasses"},{name:"angry-eyes"},{name:"deal-with-it"},{name:"disguise"},{name:"dopey-eyes"},{name:"eye-patch"},{name:"goggles"},{name:"head-arrow"},{name:"hipster-glasses"},{name:"mask"},{name:"masque"},{name:"monocle"},{name:"oval-glasses"},{name:"rectangle-glasses"},{name:"rounded-glasses"},{name:"rounded-shades"},{name:"safety-glasses"},{name:"scuba-mask"},{name:"stylish-glasses"},{name:"sunglasses"},{name:"zen-eyes"}],use_dynamic_color:!1,"z-index":500,flippable:!1,flip_x:!1,"ui-order":2},{asset_path:"grippables",allow_clear:!0,name:"flipped_grippables",dressings:[{name:"airhorn"},{name:"american-football"},{name:"baby"},{name:"banana"},{name:"baseball-bat"},{name:"baseball"},{name:"basketball"},{name:"book"},{name:"bowl"},{name:"cake"},{name:"camera"},{name:"can"},{name:"cat"},{name:"champagne"},{name:"cupcake"},{name:"dog"},{name:"downvote"},{name:"drumsticks"},{name:"ds"},{name:"erlenmeyer"},{name:"field-hockey-stick"},{name:"fish"},{name:"flower-pot"},{name:"flower"},{name:"garden-fork"},{name:"gilder"},{name:"guitar"},{name:"handbag"},{name:"ice-hockey-stick"},{name:"joystick"},{name:"keyboard"},{name:"laptop"},{name:"magnifying-glass"},{name:"megaphone"},{name:"mug"},{name:"paintbrush"},{name:"phone"},{name:"rabbit"},{name:"rubiks"},{name:"rugby-ball"},{name:"skateboard"},{name:"soccerball"},{name:"sonic-screwdriver"},{name:"spoon"},{name:"star-wand"},{name:"upvote"},{name:"whisk"},{name:"wiimote"},{name:"wrench"}],use_dynamic_color:!0,"z-index":699,flippable:!0,flip_x:!0,"ui-order":3},{asset_path:"grippables",allow_clear:!0,name:"grippables",dressings:[{name:"airhorn"},{name:"american-football"},{name:"baby"},{name:"banana"},{name:"baseball-bat"},{name:"baseball"},{name:"basketball"},{name:"book"},{name:"bowl"},{name:"cake"},{name:"camera"},{name:"can"},{name:"cat"},{name:"champagne"},{name:"cupcake"},{name:"dog"},{name:"downvote"},{name:"drumsticks"},{name:"ds"},{name:"erlenmeyer"},{name:"field-hockey-stick"},{name:"fish"},{name:"flower-pot"},{name:"flower"},{name:"garden-fork"},{name:"gilder"},{name:"guitar"},{name:"handbag"},{name:"ice-hockey-stick"},{name:"joystick"},{name:"keyboard"},{name:"laptop"},{name:"magnifying-glass"},{name:"megaphone"},{name:"mug"},{name:"paintbrush"},{name:"phone"},{name:"rabbit"},{name:"rubiks"},{name:"rugby-ball"},{name:"skateboard"},{name:"soccerball"},{name:"sonic-screwdriver"},{name:"spoon"},{name:"star-wand"},{name:"upvote"},{name:"whisk"},{name:"wiimote"},{name:"wrench"}],use_dynamic_color:!0,flippable:!0,"z-index":700,flip_x:!1,"ui-order":4},{asset_path:"hats",allow_clear:!0,name:"hats",dressings:[{name:"admiral"},{name:"beanie-bobble"},{name:"beanie"},{name:"bear-hat"},{name:"beret"},{name:"bizarro-hat"},{name:"boater"},{name:"bob"},{name:"bow"},{name:"braids"},{name:"cap"},{name:"chef-hat"},{name:"cowboy-hat"},{name:"cowl"},{name:"crown"},{name:"curly-short"},{name:"dreadlocks"},{name:"eared-hat"},{name:"fez"},{name:"flight-helmet"},{name:"fro"},{name:"headband"},{name:"headphones"},{name:"headscarf"},{name:"jester-hat"},{name:"kercheif"},{name:"lil-doo"},{name:"long-braid"},{name:"long-hair"},{name:"long-sidesweep"},{name:"long-wavy"},{name:"marilyn"},{name:"messy-short"},{name:"messy"},{name:"military-helmet"},{name:"mohawk"},{name:"mortar-board"},{name:"ninja-mask"},{name:"officer-hat"},{name:"pakol"},{name:"planetside-helmet"},{name:"rambo"},{name:"short-hat"},{name:"short-straight"},{name:"shoulder-length"},{name:"side-part"},{name:"sidecomb"},{name:"spikey"},{name:"sunhat"},{name:"tapered"},{name:"thick-wavy"},{name:"top-hat"},{name:"tousled"},{name:"trojan-helmet"},{name:"tyrolean"},{name:"viking-helmet"},{name:"wolverine-mask"}],use_dynamic_color:!1,"z-index":600,flippable:!1,flip_x:!1,"ui-order":1},{asset_path:"snoo-body",allow_clear:!1,name:"snoo-body",dressings:[{name:"body"}],use_dynamic_color:!0,flippable:!1,"z-index":50,flip_x:!1,"ui-order":0},{asset_path:"snoo-head",allow_clear:!1,name:"snoo-head",dressings:[{name:"head"}],use_dynamic_color:!0,flippable:!1,"z-index":450,flip_x:!1,"ui-order":0},{asset_path:"tops",allow_clear:!0,name:"tops",dressings:[{name:"8bit"},{name:"andre"},{name:"apron"},{name:"bhikku"},{name:"bib"},{name:"bow-tie-shirt"},{name:"cardigan"},{name:"collared-shirt"},{name:"croptop"},{name:"cylon"},{name:"deep-v"},{name:"doge-shirt"},{name:"football-jersey"},{name:"gi"},{name:"halter"},{name:"heart"},{name:"historical-costuming"},{name:"imperium"},{name:"jacket"},{name:"kendo"},{name:"lab-coat"},{name:"military"},{name:"orangered"},{name:"perwinkle"},{name:"polo"},{name:"pussycat-bow"},{name:"rainbow-vest"},{name:"shirt-tie"},{name:"ski-jacket"},{name:"soccer"},{name:"star-trek"},{name:"tank"},{name:"title-belt"},{name:"toga"},{name:"tubetop"},{name:"tux"},{name:"v-neck-curved"},{name:"v-neck"},{name:"vest-warmer"},{name:"vest"},{name:"wolverine"},{name:"zip-up"}],use_dynamic_color:!1,"z-index":300,flippable:!1,flip_x:!1,"ui-order":5}]);r.i18n.addMessages({"your browser doesn't support snoovatars :(": [null, "your browser doesn't support snoovatars :("]});